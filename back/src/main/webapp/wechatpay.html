<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1, minimum-scale=1">
    <title>微信充值</title>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
  </head>
  <body>
  </body>
  <script type="text/javascript"> 

  var basePath="http://localhost:8080/ws/";
  var dd = 1;
  $(document).ready(function(){
  	//获取个人信息
  	
  	if(isWeiXin()){
  		var thisURL = document.URL;   
  		thisURL = "http://www.sanhui.shop/marketplace/sh_chongzhi.html";
  		$.ajax({
  			type: "post",
  			url: basePath+"WXPay/getSignature",
  			dataType: "json",
  			contentType:"application/json",
  			data: thisURL,
  			success: function(datas){
  				if(datas.status==0){
  					wx.config({
  						appId: datas.data.appId,
  						timestamp:datas.data.timestamp ,
  						nonceStr: datas.data.nonce_str,
  						signature: datas.data.signature,
  						jsApiList: ['chooseWXPay'] 
  					});
  				}else{
  					dd=2;
  				}
  			}
  		});
  	}
  	
  });

  $(function(){
  	$(".btn").click(function(){ recharge(); });
  });

  function recharge(){
  	var alipayCode=$("#alipayCode").text();
  	if(alipayCode == "" && alipayCode == null){
  		layer.msg("请先完善信息~");
  		return ;
  	}
  	var recharge_value=Number($("#inputs").val());
  	
  	if(recharge_value == 0 ){
  		layer.msg("请输入充值金额~");
  		return ;
  	}
  	 if((recharge_value)%100 != 0 ){
           layer.msg("充值金额只能为100的倍数");
           return false;
  		}
  	recharge_value = "0.01";
  	if(isWeiXin()){
  		//layer.msg("微信平台现不支持支付宝支付，请用其他浏览器充值~");
  		weixinRecharge(recharge_value);
  		return ;
  	}
  	
  	$.ajax({
  		type: "post",
  		url:basePath+"userInfoRe/recharge",
  		data: {"money":recharge_value},
  		success: function(data){
  			if(data.status==800)window.location.href ="login.html";
  			if(data.status == 0){$("#tt").html(data.data);}else{layer.msg(data.errorMessage);}
  		},
  		error:function(){layer.msg("请刷新页面");}
  	});
  }

  function isWeiXin(){ 
  	var ua = window.navigator.userAgent.toLowerCase(); 
  	if(ua.match(/MicroMessenger/i) == 'micromessenger'){return true; }else{ return false; } 
  } 

  /**
   * 微信支付
   * @param num
   */
  var bb = true ;
  function weixinRecharge(money){
  	if (typeof WeixinJSBridge == "undefined"){
  		layer.msg("微信浏览器系统版本过低，请将微信升级至5.0以上");
  		if( document.addEventListener ){
  			document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
  		}else if (document.attachEvent){
  			document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
  			document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
  		}
  	}else{
  		if(bb){
  			bb=false;
  			$.post(basePath+"WXPay/wxRecharge",{"money":money},function(data){
  				if(data.status == 0){/*成功*/onBridgeReady(data);bb=true;}else{/*失败*/layer.msg(data.errorMessage+"~~");bb=true;}
  			});
  		}else{
  			alert("正在支付...请稍等");
  		}
  	}
  	
  }

  function onBridgeReady(data){
  	var str=window.navigator.userAgent;
  	var version=str.substring(8,11);
  	if(version!="5.0"){
  		layer.msg("微信浏览器系统版本过低，请将微信升级至5.0以上");
  		return false;
  	}else{
  		if(dd == 1){
  			var out_trade_no = data.data.out_trade_no;
  			wx.chooseWXPay({
  			    timestamp:  data.data.timeStamp,
  			    nonceStr: data.data.nonceStr,
  			    package: data.data.pk,
  			    signType: 'MD5',
  			    paySign: data.data.paySign,
  			    success: function (res) {
  			    	if(res.errMsg=="chooseWXPay:ok"){
  			    		//修改 
  			    		$.ajax({
  			    			type: "post",
  			    			url: basePath+"WXPay/paySU",
  			    			dataType: "json",
  			    			contentType:"application/json",
  			    			data: out_trade_no,
  			    			success: function(datas){
  			    				bb=true;
  								if(datas.status==0){window.location.href ="user_wallet1.html";}else{layer.mag(datas.msg);}
  			    			}
  			    		});
  					}
  			    }
  			});
  		}else{
  			layer.msg("暂时不能支付，请稍等！！");
  		}
  		bb=true;
  	}
  }



  </script>
</html>
